"use strict";var revoList=function(){return{app:angular.module("revo-list",["ngRoute","ngResource","ui.bootstrap"]),appTitle:"revoList"}}();revoList.app.config(["$routeProvider","$locationProvider","$httpProvider",function($routeProvider,$locationProvider,$httpProvider){$routeProvider.when("/",{templateUrl:"partials/profile"}).when("/profile/:user",{templateUrl:"partials/profile"}).when("/search/:query",{templateUrl:function(){return"partials/search"}}).when("/profile/:userId",{templateUrl:"partials/profile"}).when("/playlist/:playlistId",{templateUrl:"partials/playlist"}).when("/:partial",{controller:"defaultController",templateUrl:function(routeValues){return"partials/"+routeValues.partial}}).otherwise({redirectTo:"/"}),$locationProvider.html5Mode(!0),$httpProvider.defaults.headers.common["X-Requested-With"]="XMLHttpRequest"}]).factory("$exceptionHandler",["$log","log",function($log,log){var logger=new log("$exceptionHandler");return function(exception){$log.error(exception),logger.error({msg:exception.message,stack:exception.stack})}}]),revoList.app.controller("addToModalController",["$scope","apiData","me",function($scope,apiData){apiData.playlist.byTrack($scope.track).then(function(data){$scope.playlists=data}),$scope.addToNewPlaylist=function(){apiData.playlist.create({title:$scope.newPlaylist}).then(function(newPlaylist){$scope.addToPlaylist(newPlaylist._id)})},$scope.addToPlaylist=function(playlistId){apiData.playlist.addTrack(playlistId,$scope.track).then(function(){$scope.$close()})},$scope.removeFromPlaylist=function(playlistId){apiData.playlist.removeTrack(playlistId,$scope.track).then(function(){$scope.$close()})}}]),revoList.app.controller("addToModalPlaylistController",["$scope",function($scope){$scope.$watch("p.selected",function(nv,ov){nv!==ov&&(nv===!0?$scope.addToPlaylist($scope.p._id):$scope.removeFromPlaylist($scope.p._id))})}]),revoList.app.controller("appController",["$scope","me","$location","$route",function($scope,me,$location){me().then(function(user){$scope.currentUser=user}),$scope.search=function(){var q=$scope.searchQuery;q&&q.length&&$location.path("/search/"+encodeURI(q))},$scope.$on("$locationChangeSuccess",function(){0!==$location.path().indexOf("/search")&&($scope.searchQuery="")})}]),revoList.app.controller("chartController",["$scope","apiData",function($scope,apiData){apiData.playlist.query().then(function(data){$scope.playlists=data})}]),revoList.app.controller("defaultController",["$scope",function($scope){$scope.message="default message"}]),revoList.app.controller("editPlaylistController",["$scope","apiData",function($scope,apiData){$scope.remove=function(index){apiData.playlist.removeTrack($scope.playlist._id,$scope.tracks[index]).then(function(){$scope.tracks.splice(index,1)})},$scope["delete"]=function(){apiData.playlist.remove($scope.playlist).then(function(){var ps=$scope.$parent.$parent.$parent.playlists,i=ps.indexOf($scope.playlist);i>=0&&(ps.splice(i,1),$scope.$close())})},$scope.changeTitle=function(){apiData.playlist.changeTitle($scope.playlist._id,$scope.newTitle).then(function(){$scope.playlist.title=$scope.newTitle})},$scope.newTitle=$scope.playlist.title}]),revoList.app.controller("homeController",["$scope",function($scope){$scope.message="Welcome to revoList!"}]),revoList.app.controller("logonController",["$scope",function($scope){$scope.logon=function(){FB.login(function(response){$scope.$close(response.authResponse)})}}]),revoList.app.controller("playlistController",["$scope","apiData","$routeParams","$q","me","$modal",function($scope,apiData,$routeParams,$q,me,$modal){function loadDirectiveData(){apiData.track.get($scope.playlist.tracks[0]).then(function(t){$scope.playlist.thumbnail=t.thumbnail}),apiData.user.get($scope.playlist.owner).then(function(u){$scope.ownerInstance=u}),me().then(function(u){$scope.me=u,$scope.playlist.likes&&-1!==$scope.playlist.likes.indexOf(u._id)&&($scope.liked=!0)}),$scope.tracks=[],$scope.playlist.tracks.forEach(function(tid){apiData.track.get(tid).then(function(t){$scope.tracks.push(t)})})}$scope.init=function(playlist){$scope.playlist=playlist,loadDirectiveData()},$scope.like=function(){apiData.playlist.like($scope.playlist._id).then(function(){$scope.liked=!0,$scope.playlist.likes=$scope.playlist.likes||[],$scope.playlist.likes.push($scope.me._id)})},$scope.dislike=function(){apiData.playlist.dislike($scope.playlist._id).then(function(){$scope.liked=!1,$scope.playlist.likes.splice($scope.playlist.likes.indexOf($scope.me._id),1)})},$scope.edit=function(){var mScope=$scope.$new();mScope.playlist=$scope.playlist,mScope.tracks=$scope.tracks,$modal.open({templateUrl:"/partials/editPlaylist",scope:mScope})},$routeParams.playlistId&&apiData.playlist.get($routeParams.playlistId).then(function(p){$scope.playlist=p,loadDirectiveData()})}]),revoList.app.controller("profileController",["$scope","apiData","me","$routeParams","$q",function($scope,apiData,me,$routeParams,$q){function loadPlaylists(owner){apiData.playlist.query({owner:owner}).then(function(data){$scope.playlists=data})}function loadLikes(owner){apiData.user.likes(owner).then(function(data){$scope.likes=data})}function currentUser(){var d=$q.defer();return $routeParams.user?apiData.user.get($routeParams.user).then(function(u){d.resolve(u)}):me().then(function(u){d.resolve(u)}),d.promise}currentUser().then(function(u){loadPlaylists(u._id),loadLikes(u._id),$scope.user=u})}]),revoList.app.controller("searchController",["$scope","apiData","$routeParams",function($scope,apiData,$routeParams){function setUserPic(user){FB.api("/"+user.id+"/picture?type=large",function(resp){user.picture=resp.data.url})}$scope.searchQuery=$routeParams.query,apiData.search.query({q:decodeURI($scope.searchQuery)}).then(function(data){$scope.trackResult=data}),apiData.playlist.search($scope.searchQuery).then(function(data){$scope.playlistResult=data}),apiData.user.search($scope.searchQuery).then(function(data){$scope.userResult=data,$scope.userResult.forEach(function(u){setUserPic(u)})})}]),revoList.app.directive("displayPlaylist",[function(){return{templateUrl:"/partials/display-playlist",restrict:"EAC"}}]),revoList.app.directive("displayTrack",["player","$modal","$timeout","$location","$rootScope",function(player,$modal,$timeout,$location,$rootScope){function link(scope,elem){function handleLoadedTrack(track){isOwnTrack(scope,track)?(playing=!0,paused=!1,$(elem).addClass("current"),trackPausedHandler=player.on("paused",function(){onPaused()}),trackPlayingHandler=player.on("playing",function(){onPlaying()})):(paused=!1,playing=!1,$(elem).removeClass("current"),trackPausedHandler&&trackPausedHandler(),trackPlayingHandler&&trackPlayingHandler())}function onPlaying(){$(elem).addClass("playing"),$(elem).removeClass("paused"),paused=!1,playing=!0}function onPaused(){$(elem).addClass("paused"),$(elem).removeClass("playing"),paused=!0,playing=!1}function locateTrack(){$("html, body").animate({scrollTop:$(elem).find(".track-cell").offset().top-20+"px"},"fast")}var trackLoadedHandler,trackPausedHandler,trackPlayingHandler,playing,paused;trackLoadedHandler=player.on("trackLoaded",function(track){handleLoadedTrack(track)}),$(elem).on("remove",function(){trackLoadedHandler(),trackPausedHandler(),trackPlayingHandler()}),scope.play=function(){playing?player.pause():paused?player.play():player.playTrack(scope.playlist,scope.i,scope.sourceUrl)},scope.addToPlaylist=function(){var mScope=scope.$new();mScope.track=scope.track,$modal.open({templateUrl:"/partials/addToPlaylist",size:"md",scope:mScope})},$timeout(function(){handleLoadedTrack(player.currentTrack),isOwnTrack(scope,player.currentTrack)&&(player.isPlaying?onPlaying():onPaused(),"locate"===$location.hash()&&locateTrack())}),$rootScope.$on("locateTrack",function(e,track){isOwnTrack(scope,track)&&locateTrack()})}function isOwnTrack(scope,track){return track?scope.track.id===track.id&&scope.track.provider===track.provider:!1}return{restrict:"ECA",scope:{track:"=",playlist:"=",i:"=",sourceUrl:"@"},templateUrl:"/partials/display-track",link:link}}]),revoList.app.directive("displayUser",function(){return{templateUrl:"/partials/display-user",restrict:"CAE",scope:{user:"="}}}),revoList.app.directive("mobileClass",function(){function link(scope,elem,attr){var classes=attr.mobileClass.split(":");$("html.mobile").length?$(elem).addClass(classes[0]):classes[1]&&$(elem).addClass(classes[1])}return{restrict:"A",link:link}}),revoList.app.directive("navButton",["$location",function($location){function link(scope,elem){scope.$on("$routeChangeSuccess",function(){$location.path()===$(elem).attr("href")?$(elem).addClass("active"):$(elem).removeClass("active")})}return{restrict:"CAE",link:link}}]),revoList.app.directive("partial",[function(){return{link:function(scope,element){document.title=revoList.appTitle+" - "+element.attr("title")},restrict:"EC"}}]),revoList.app.directive("playerUi",["$rootScope","$location",function($rootScope,$location){function controller($scope,$element,player){$scope.player=player,player.on("playing",function(){$scope.$apply(function(){$scope.isPlaying=!0})}),player.on("paused",function(){$scope.$apply(function(){$scope.isPlaying=!1})}),player.on("trackLoaded",function(track,sourceUrl){$scope.currentTrack=track,$scope.sourceUrl=sourceUrl,$($element).show(),$("#wrapper").css("padding-bottom","100px")}),$scope.locateTrack=function(){$location.path()!==$scope.sourceUrl?$location.path($scope.sourceUrl).hash("locate"):$rootScope.$broadcast("locateTrack",player.currentTrack)}}return{restrict:"AEC",controller:["$scope","$element","player",controller],scope:{},templateUrl:"/partials/player"}}]),revoList.app.directive("rlOverlay",function(){return{link:function(scope,elem){$(elem).hover(function(){$(this).find(".overlay").css("display","block")},function(){$(this).find(".overlay").css("display","")})},restrict:"C"}}),revoList.app.directive("slider",["player",function(player){var _link=function(scope,elem){var sliderInstance=$(elem).slider({formatter:function(raw){var hr=raw%3600,h=(raw-hr)/3600,mr=hr%60,m=(hr-mr)/60;return(0!==h?h+":":"")+(m>9?m:"0"+m)+":"+(mr>9?mr:"0"+mr)}});sliderInstance.slider("setValue",0);var durationSet=!1,isSliding=!1;player.on("trackLoaded",function(){sliderInstance.slider("setValue",0),durationSet=!1}),player.on("progress",function(prog){durationSet||(sliderInstance.slider("setAttribute","max",prog.duration),prog.duration&&(durationSet=!0)),isSliding||sliderInstance.slider("setValue",prog.current)}),sliderInstance.slider("on","slideStart",function(){isSliding=!0}),sliderInstance.slider("on","slideStop",function(e){isSliding=!1,player.seekTo(e.value)})};return{restrict:"EAC",link:_link}}]),revoList.app.directive("youtubeTrack",function(){}),revoList.app.filter("likesCount",function(){return function(input){return"number"==typeof input?1===input?"1 like":input+" likes":"0 likes"}}),revoList.app.filter("tracksCount",function(){return function(input){return"number"==typeof input?1===input?"1 track":input+" tracks":"0 tracks"}}),revoList.app.filter("username",function(){return function(input){return"object"==typeof input?input.firstName+" "+input.lastName:""}}),revoList.app.factory("api",["$resource","$http","$q","config","auth",function($resource,$http,$q,config,auth){function Api(entityType){return this instanceof Api?(this.entityType=entityType,void(this.res=void 0)):(_apiInstanceCache[entityType]||(_apiInstanceCache[entityType]=new Api(entityType)),_apiInstanceCache[entityType])}var apiConf=function(){function apiConf(){var d=$q.defer();return"undefined"!=typeof _apiConf?d.resolve(_apiConf):config().then(function(val){_apiConf=val.api,d.resolve(_apiConf)}),d.promise}var _apiConf;return apiConf}(),_apiInstanceCache={};return Api.auth=auth,Api.prototype={resource:function(){var d=$q.defer(),_this=this;return"undefined"!=typeof this.res?d.resolve(this.res):$q.all([apiConf(),auth.accessToken()]).then(function(resp){_this.res=$resource(resp[0].url,{entity:_this.entityType,id:"@_id",accessToken:resp[1]},{create:{method:"post"},update:{method:"put"}}),d.resolve(_this.res)}),d.promise},get:function(id){var d=$q.defer();return this.resource().then(function(res){res.get({id:id},function(data){d.resolve(data)})}),d.promise},query:function(filter){var d=$q.defer();return this.resource().then(function(res){res.query(filter,function(data){d.resolve(data)})}),d.promise},create:function(model){var d=$q.defer();return this.resource().then(function(res){var entity=new res(model);entity.$create(function(data){d.resolve(data)})}),d.promise},update:function(model){var d=$q.defer();return this.resource().then(function(res){var entity=new res(model);entity.$update(function(data){d.resolve(data)})}),d.promise},remove:function(model){var d=$q.defer();return this.resource().then(function(res){var entity=new res(model);entity.$delete(function(data){d.resolve(data)})}),d.promise}},Api.url=function(path,config){config=config||{},config.params=config.params||{},"/"!==path[0]&&(path="/"+path);var d=$q.defer();return $q.all([apiConf(),auth.accessToken()]).then(function(r){config.url=r[0].base.replace("{{path}}",path),config.params.access_token=r[1],$http(config).then(function(resp){d.resolve(resp.data)})}),d.promise},Api}]),revoList.app.factory("apiData",["api","$q","$http",function(api){function DataLayer(entityType){this.api=api(entityType)}return DataLayer.prototype={get:function(id){return this.api.get(id)},query:function(filter){return this.api.query(filter)},create:function(model){return this.api.create(model)},update:function(model){return this.api.update(model)},remove:function(model){return this.api.remove(model)},action:function(name,id,config){return api.url(this.api.entityType+"/"+(null!=id?id+"/":"")+name,config)}},{user:function(){var layer=new DataLayer("user");return layer.me=function(){return api.url("/user/me")},layer.likes=function(userId){return this.action("likes",userId)},layer.search=function(query){return this.action("search",void 0,{params:{q:query}})},layer}(),playlist:function(){var layer=new DataLayer("playlist");return layer.my=function(){return this.action("my")},layer.addTrack=function(playlistId,track){return this.action("addTrack",playlistId,{method:"POST",data:track})},layer.removeTrack=function(playlistId,track){return this.action("removeTrack",playlistId,{method:"POST",data:track})},layer.byTrack=function(track){return api.url("playlist/byTrack/"+track.provider+"/"+track.id)},layer.like=function(playlistId){return this.action("like",playlistId)},layer.dislike=function(playlistId){return this.action("dislike",playlistId)},layer.changeTitle=function(playlistId,newTitle){return this.action("changeTitle",playlistId,{params:{title:newTitle}})},layer.search=function(query){return this.action("search",void 0,{params:{q:query}})},layer}(),search:function(){var layer=new DataLayer("search");return layer}(),track:function(){var layer=new DataLayer("track");return layer}()}}]),revoList.app.factory("auth",["$http","config","fbAuth","$q","log",function($http,config,fbAuth,$q,log){function auth(){return isAuthenticating||(authDeferred=$q.defer(),isAuthenticating=!0,$q.all([fbAuth(),config()]).then(function(resp){var creds=resp[0],ac=resp[1].api;$http({method:"POST",url:ac.base.replace("{{path}}","/oauth/token"),data:$.param({username:creds.uid,password:creds.accessToken,grant_type:"password"}),headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:"Basic "+btoa("revoList_webApp_client:revoList_webApp_secret")}}).success(function(resp){authDeferred.resolve(resp)}).error(function(resp){alert("auth error"),authDeferred.reject(resp)})["finally"](function(){isAuthenticating=!1})})),authDeferred.promise}{var authDeferred,isAuthenticating=!1;new log("auth")}return auth.user=function(){function _getUser(){return _user}function _setUser(usr){_user=usr}function user(){var d=$q.defer(),u=_getUser();return"undefined"==typeof u?auth().then(function(){_setUser(),d.resolve()}):d.resolve(u),d.promise}var _user;return user}(),auth.accessToken=function(){function _setAccessToken(host,authResp){$.cookie("revoList_"+host,authResp.access_token,{expires:1,path:"/"}),$.cookie("revoList_"+host+"_v",_currentVersion,{path:"/"})}function _getAccessToken(host){return $.cookie("revoList_"+host+"_v")===_currentVersion?$.cookie("revoList_"+host):void 0}function accessToken(force){var d=$q.defer();return config().then(function(cfg){var _accessToken=_getAccessToken(cfg.api.host);null==_accessToken||force?auth().then(function(resp){_setAccessToken(cfg.api.host,resp),d.resolve(resp.access_token)}):d.resolve(_accessToken)}),d.promise}var _currentVersion="1";return accessToken}(),auth}]),revoList.app.factory("config",["$http","$q",function($http,$q){var conf;return function(){var d=$q.defer();return"undefined"!=typeof conf?d.resolve(conf):$http.get("/config").then(function(resp){conf=resp.data,d.resolve(conf)}),d.promise}}]),revoList.app.factory("fbAuth",["$q","$modal","log","config",function($q,$modal,log,config){function authInfo(fb){var d=$q.defer();return config().then(function(cfg){fb.init({appId:cfg.FB.appId,xfbml:!1,version:"v2.1",status:!0}),fb.getLoginStatus(function(response){"connected"===response.status?d.resolve(response.authResponse):(logger.info("starting Facebook authentication process"),$modal.open({templateUrl:"/partials/logon",keyboard:!1,size:"md",backdrop:"static"}).result.then(function(response){d.resolve(response)}))})}),d.promise}function resolve(deferred){authInfo(window.FB).then(function(resp){deferred.resolve({uid:resp.userID,accessToken:resp.accessToken})})}var logger=new log("fbAuth");return function(){var d=$q.defer();return window.FB?resolve(d):window.fbAsyncInit=function(){resolve(d)},d.promise}}]),revoList.app.factory("log",[function(){function request(level,data){req.open("post","/log/"+level,!0),req.setRequestHeader("Content-Type","application/json"),req.setRequestHeader("X-Requested-With","XMLHttpRequest"),req.send(JSON.stringify(data))}function RemoteLogger(component){this.comp=component}var req=new XMLHttpRequest;return RemoteLogger.prototype={info:function(msg){request("info",{component:this.comp,msg:msg})},error:function(err){err.component=this.comp,request("error",err)}},RemoteLogger}]),revoList.app.factory("me",["apiData","$q",function(apiData,$q){var _me;return function(){var d=$q.defer();return _me?d.resolve(_me):apiData.user.me().then(function(user){_me=user,d.resolve(_me)}),d.promise}}]),revoList.app.factory("player",["youtubePlayer","soundcloudPlayer",function(youtubePlayer,soundcloudPlayer){function Player(){var _this=this;this.isPlaying=!1,this.currentTrack=void 0,this.player=void 0,this.currentPlaylist=[],this.currentIndex=0,this.sourceUrl=void 0,this.events={ended:function(){_this.next()},paused:function(){_this.isPlaying=!1,_this.trigger("paused")},playing:function(){_this.isPlaying=!0,_this.trigger("playing")},ready:function(){_this.play()},progress:function(p){_this.trigger("progress",p)}},this.listeners={playing:[],paused:[],progress:[],trackLoaded:[]}}return Player.prototype={playTrack:function(playlist,index,sourceUrl){this.currentPlaylist=playlist,this.currentIndex=index,this.sourceUrl=sourceUrl,this.loadTrack(playlist[index])},loadTrack:function(track){switch(this.currentTrack&&this.currentTrack.provider!==track.provider&&this.player&&this.player.stop(),this.currentTrack=track,track.provider){case"youtube":this.player=new youtubePlayer(this.events);break;case"soundcloud":this.player=new soundcloudPlayer(this.events)}this.player.loadTrack(track),this.trigger("trackLoaded",track,this.sourceUrl)},next:function(){this.currentPlaylist.length&&(this.currentIndex<this.currentPlaylist.length-1?this.currentIndex++:this.currentIndex=0,this.loadTrack(this.currentPlaylist[this.currentIndex]))},previous:function(){this.currentPlaylist.length&&(this.currentIndex>0?this.currentIndex--:this.currentIndex=this.currentPlaylist.length-1,this.loadTrack(this.currentPlaylist[this.currentIndex]))},play:function(){this.player&&this.currentTrack&&this.player.play()},pause:function(){this.player&&this.currentTrack&&this.player.pause()},on:function(event,handler){var _this=this;return this.listeners[event].push(handler),function(){var i=_this.listeners[event].indexOf(handler);i>=0&&_this.listeners[event].splice(i,1)}},trigger:function(event){var args=Array.prototype.slice.call(arguments).splice(1);this.listeners[event].forEach(function(l){l.apply(void 0,args)})},seekTo:function(seconds){this.player.seekTo(seconds)}},new Player}]),revoList.app.service("soundcloudPlayer",[function(){function SoundcloudPlayer(events){var _this=this;this.events=events,this.options={buying:!1,liking:!1,download:!1,sharing:!1,show_artwork:!1,show_comments:!1,show_playcount:!1,show_user:!1,callback:function(){_this.play()}}}var containerId="soundcloud-player-container",player=void 0;return SoundcloudPlayer.prototype={loadTrack:function(track){player||this.loadPlayer(),player.load("http://api.soundcloud.com/tracks/"+track.id,this.options)},loadPlayer:function(){var _this=this;player=SC.Widget(containerId),player.bind(SC.Widget.Events.READY,function(){}),player.bind(SC.Widget.Events.PLAY,function(){_this.events.playing()}),player.bind(SC.Widget.Events.PAUSE,function(){_this.events.paused()}),player.bind(SC.Widget.Events.FINISH,function(){_this.events.ended()}),player.bind(SC.Widget.Events.PLAY_PROGRESS,function(e){_this.getDuration(function(d){_this.events.progress({current:e.currentPosition/1e3,duration:d/1e3})})})},getDuration:function(){var duration=void 0;return function(callback){"undefined"!=typeof duration?callback(duration):player.getDuration(function(d){duration=d,callback(duration)})}}(),play:function(){player&&player.play()},pause:function(){player&&player.pause()},stop:function(){player&&player.pause()},seekTo:function(seconds){player&&player.seekTo(1e3*seconds)}},SoundcloudPlayer}]),revoList.app.service("youtubePlayer",[function(){function YoutubePlayer(events){this.events=events}var containerId="youtube-player-container",player=void 0,progressInt=void 0;return YoutubePlayer.prototype={loadTrack:function(track){player?player.loadVideoById(track.id):this.loadPlayer(track)},loadPlayer:function(track){var _this=this;player=new YT.Player(containerId,{height:50,width:100,videoId:track.id,playerVars:{controls:0,enablejsapi:1,disablekb:0,rel:0,playsinline:0,showinfo:0},events:{onReady:function(){_this.play()},onStateChange:function(e){_this.stateChanged(e)}}})},play:function(){player&&player.playVideo()},pause:function(){player&&player.pauseVideo()},stop:function(){this.clearInterval(),player&&player.stopVideo()},seekTo:function(seconds){player&&player.seekTo(seconds,!0)},stateChanged:function(event){var _this=this;switch(event.data){case YT.PlayerState.CUED:this.events.ready();break;case YT.PlayerState.ENDED:this.events.ended(),this.clearInterval();break;case YT.PlayerState.PAUSED:this.events.paused(),this.clearInterval();break;case YT.PlayerState.PLAYING:this.events.playing(),"undefined"==typeof progressInt&&(progressInt=window.setInterval(function(){_this.events.progress({current:player.getCurrentTime(),duration:player.getDuration()})},200))}},clearInterval:function(){window.clearInterval(progressInt),progressInt=void 0}},YoutubePlayer}]);
//# sourceMappingURL=app.min.js.map